<!doctype>
<head>
    <link type="text/css" rel="stylesheet" href="rickshaw/src/css/graph.css">
    <link type="text/css" rel="stylesheet" href="rickshaw/examples/css/lines.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.13.3/react.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.13.3/JSXTransformer.js"></script>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.1/jquery.min.js"></script>
    <!--
    <script src="rickshaw/vendor/d3.v3.js"></script>


    <script src="rickshaw/rickshaw.js"></script>
    <script src="rickshaw/src/js/Rickshaw.Graph.Legend.js"></script>
    <script src="rickshaw/src/js/Rickshaw.Color.Palette.js"></script>
-->
    <script src="https://cdn.socket.io/socket.io-1.3.5.js"></script>
</head>
<body>

    <div id="meters"></div>
    <script type="text/jsx">

    var Meter = React.createClass({
        render: function() {
            return (
                <div>{this.props.name}: {this.props.value} {this.props.unit}</div>
            );
        }
    });
    

    var Meters = React.createClass({
        componentDidMount: function() {
            var that = this;
            this.socket = io();
            this.socket.on('meter update', function (data) {
                that.addMeterUpdate(data);
            });
        },

        addMeterUpdate: function(update) {
            var data = this.props.data;
            var len = data.length;

            for (var i = 0; i < len; i++) {
                if(data[i].meter == update.meter) {
                    data[i] = update;
                }
            }
            this.setState(data);
        },

        render: function() {
            
            var meters = this.props.data.map(function (meter) {
                return (
                    <Meter name={meter.name} value={meter.value} unit={meter.unit} />
                );
            });

            return (    
                <div>
                    <h1>Meters</h1>
                    {meters}
                </div>
            );
        }
    });

    $.getJSON( "/api/currentabsolutevalues", function( data ) {

    var ui = React.render(
        <Meters data={data} />,
        document.getElementById('meters')
      );
    });

    </script>

<div id="chart_container">
    <div id="chart"></div>
</div>

<script>

/*
var palette = new Rickshaw.Color.Palette( { scheme: 'classic9' } );

var graph = new Rickshaw.Graph.Ajax( {

    element: document.getElementById("chart"),
    width: 400,
    height: 200,
    renderer: 'line',
    //dataURL: '/api/allvalues',
    //dataURL: '/api/currentabsolutevalues',
    //onData: function(d) { d[0].data[0].y = 80; return d },
} );
*/
//graph.render();
/*
var slider = new Rickshaw.Graph.RangeSlider({
    graph: graph,
    element: document.querySelector('#slider')
});

var legend = new Rickshaw.Graph.Legend( {
    graph: graph,
    element: document.getElementById('legend')

} );

var xAxis = new Rickshaw.Graph.Axis.Time( {
    graph: graph,
    ticksTreatment: ticksTreatment,
    timeFixture: new Rickshaw.Fixtures.Time.Local()
} );

xAxis.render();
*/


</script>
</body>